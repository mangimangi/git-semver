# git-block — Generic Vendor File Protection

## Problem

Every vendored tool (pearls, git-semver) ships its own bespoke "check implementation files" workflow. These are 150-200 lines of tool-specific bash that know about specific directories, allowed files, config flags, etc. When a new tool is vendored, it needs its own check workflow. This doesn't scale.

## Solution

**git-block** is a generic, lightweight tool that protects vendored files via a single config-driven GHA workflow. Instead of each tool knowing how to protect its own files, git-block provides one workflow that reads `.block/config.json` and enforces protections for all registered vendors.

## Design Decisions

### Config is the source of truth

`.block/config.json` contains the complete registry of protected/allowed files per vendor. If a file isn't in config, it's not protected. No implicit "protect everything in directory X" — only explicitly listed patterns are checked.

### Direct config edit (not CLI)

Vendors edit `.block/config.json` directly during their install (via python/jq). No dependency on a git-block CLI being available. This is the lightest integration path.

### Conditional protection at install time

The current pearls workflow has runtime logic like "if `install.agents_md` is false, then `.pearls/AGENTS.md` is allowed." With git-block, this moves to install time — the install script reads its own config and registers the correct allowed/protected set. Re-running the install updates the registration. The check workflow stays dumb.

### Per-vendor install branch skip

Each vendor registers an `install_branch` prefix. A pearls install PR (`chore/install-pearls-*`) only skips pearls protections, not git-semver's. The check workflow reads these prefixes from config.

### GHA PR check only (no local hooks)

MVP scope. A pre-commit hook could come later but isn't needed to start.

## Config Schema

```json
{
  "vendors": {
    "<vendor-name>": {
      "install_branch": "<branch-prefix>",
      "protected": ["<glob-pattern>", ...],
      "allowed": ["<glob-pattern>", ...]
    }
  }
}
```

Example:

```json
{
  "vendors": {
    "git-block": {
      "install_branch": "chore/install-git-block",
      "protected": [".block/**", ".github/workflows/check-vendor.yml"],
      "allowed": [".block/config.json"]
    },
    "git-semver": {
      "install_branch": "chore/install-git-semver",
      "protected": [".semver/**"],
      "allowed": [".semver/config.json", ".semver/.version"]
    },
    "pearls": {
      "install_branch": "chore/install-pearls",
      "protected": [".pearls/**"],
      "allowed": [
        ".pearls/issues.jsonl",
        ".pearls/config.json",
        ".pearls/.prl-version",
        ".pearls/archive/*.jsonl"
      ]
    }
  }
}
```

## Check Logic (pseudo)

```
for each vendor in config.vendors:
  if PR branch starts with vendor.install_branch → skip this vendor
  for each changed file:
    if file matches any vendor.protected pattern:
      if file does NOT match any vendor.allowed pattern:
        → violation
```

## How Install Scripts Register

Each vendor's install script adds a snippet like:

```bash
# Register with git-block if present
if [ -f .block/config.json ]; then
  python3 << 'PYEOF'
import json
with open('.block/config.json') as f:
    config = json.load(f)
config.setdefault('vendors', {})
config['vendors']['my-tool'] = {
    'install_branch': 'chore/install-my-tool',
    'protected': ['.my-tool/**'],
    'allowed': ['.my-tool/config.json']
}
with open('.block/config.json', 'w') as f:
    json.dump(config, f, indent=2)
    f.write('\n')
PYEOF
fi
```

## What git-block Replaces

In repos that use git-block, `check-pearls-impl.yml` (and any future tool-specific check workflow) goes away entirely. The single `check-vendor.yml` handles all vendors.

## File Layout (git-block repo)

```
git-block/
├── install.sh                              # Install script
├── VERSION                                 # Version tracking
└── templates/
    └── github/workflows/
        └── check-vendor.yml                # The one workflow
```

The install script:
1. Creates `.block/` dir
2. Creates `.block/config.json` if missing (empty vendors)
3. Installs `.github/workflows/check-vendor.yml` (always overwrites — it's implementation, not config)
4. Registers git-block itself as a vendor
5. Writes `.block/.version`
