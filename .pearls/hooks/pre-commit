#!/bin/bash
# .pearls/hooks/pre-commit
# Pre-commit hook that prevents direct edits to vendored implementation files.
# Reads .vendored/config.json for protected/allowed glob patterns per vendor.
#
# Each vendor entry in .vendored/config.json has:
#   protected:      glob patterns for files that should not be modified directly
#   allowed:        glob patterns for exceptions within protected paths
#   install_branch: branch prefix where vendor updates are allowed
#
# Installed by configure.sh as a symlink from .git/hooks/pre-commit.

# No vendored config â€” skip vendor checks
if [ ! -f .vendored/config.json ]; then
    exit 0
fi

# Get staged files
STAGED=$(git diff --cached --name-only)
if [ -z "$STAGED" ]; then
    exit 0
fi

# Get current branch for install-branch skip logic
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || true)

# Use python3 for glob matching (fnmatch handles ** and * patterns)
VIOLATIONS=$(echo "$STAGED" | python3 -c "
import json, fnmatch, sys

branch = sys.argv[1]
staged = [line.strip() for line in sys.stdin if line.strip()]

with open('.vendored/config.json') as f:
    config = json.load(f)

violations = []
for name, vendor in config.get('vendors', {}).items():
    install_branch = vendor.get('install_branch', '')
    if install_branch and branch.startswith(install_branch):
        continue

    protected = vendor.get('protected', [])
    allowed = vendor.get('allowed', [])

    for f in staged:
        is_protected = any(fnmatch.fnmatch(f, p) for p in protected)
        is_allowed = any(fnmatch.fnmatch(f, a) for a in allowed)
        if is_protected and not is_allowed:
            violations.append(f)

for v in sorted(set(violations)):
    print(f'  {v}')
" "$BRANCH" 2>/dev/null)

if [ -n "$VIOLATIONS" ]; then
    echo "Error: Vendored implementation files should not be modified directly." >&2
    echo "" >&2
    echo "The following installed files were staged:" >&2
    echo "$VIOLATIONS" >&2
    echo "" >&2
    echo "These files are managed by their respective install processes." >&2
    echo "To update them, re-run the install script or merge an install PR." >&2
    echo "" >&2
    echo "If you need to change the source, submit a PR to the upstream repository." >&2
    echo "" >&2
    echo "Under no circumstances should you bypass this check." >&2
    exit 1
fi
